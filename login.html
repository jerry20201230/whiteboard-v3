<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>畫板 - 登入</title>
    <link id="browser-icon" rel="shortcut icon" type="image/png" href="/lib/icon-active.png" />

    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.1/css/bootstrap.css'
        integrity='sha512-tBwPRcI1t+0jTsIMtf//+V1f0xAWHh7pvPE82A2n5FcBrzl6b0LRE6XnxUTRHti59y4Js7z4Wb/zal2HBsVVOQ=='
        crossorigin='anonymous' />
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.9.1/font/bootstrap-icons.css'
        integrity='sha512-CaTMQoJ49k4vw9XO0VpTBpmMz8XpCWP5JhGmBvuBqCOaOHWENWO1CrVl09u4yp8yBVSID6smD4+gpzDJVQOPwQ=='
        crossorigin='anonymous' />


    <style>
        .login-dialog,
        .full-screen-dialog {
            backdrop-filter: blur(10px);
            background: rgba(216, 216, 216, 0.355);
            border-radius: 5px;
            box-shadow: 0px 0px 20px 5px rgb(216 216 216 / 50%);
            position: absolute;
            top: 50%;
            left: 50%;

            max-width: 500px !important;
            min-width: 300px;
            width: 50vw;


            transform: translate(-50%, -50%);
            padding: 15px;

            transition: box-shadow 1s;

        }

        .form-check {
            padding: 0;
        }

        #login-dialog-hide {
            display: none !important;
        }

        #login-dialog-show {
            display: block;
        }

        .center {
            text-align: center !important;
        }

        .select-none {
            user-select: none;
        }

        #bg-img {
            position: fixed;
            top: 50%;
            left: 50%;
            z-index: -99;
        }
    </style>

</head>

<body onload="window.setup()">

    <div id="loading-layer" style="    
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    width: 100vw;
    height: 100vh;
    background-color:var(--bs-light);
    display: flex;
    align-items: center;
    flex-direction: column;
    justify-content: center;
    text-align: center;">

        <img src="/lib/icon-active.png" style="max-width: 3em;" alt="白板-logo">

        <p></p>
        <h3 id="loading-status">資料讀取中</h3>
        <p></p>
        <div id="loading-failed-text-container"></div>

    </div>



    <div id="background"></div>
    <div id="login-dialog" class="login-dialog">
        <h1>登入</h1>
        <p>登入以使用白板的所有功能<br>
            如果沒有帳號，請先註冊</p>
        <p>
        <div class="form-check mb-3">
            <label for="user_account">使用者帳號:</label>

            <div class="input-group mb-3">
                <span class="input-group-text">@</span><input type="text" class="form-control" placeholder="使用者帳號"
                    id="user_account">
            </div>

            <div class="invalid-feedback" id="login_user_account_alert" style="display: none;"></div>
        </div>
        <div class="form-check mb-3">
            <label for="user_password">使用者密碼:</label><input type="password" class="form-control" placeholder="使用者密碼"
                id="user_password">
            <span class="badge bg-danger" id="login_user_password_alert" style="display: none;"></span>

        </div>
        <div class="alert alert-danger" id="login_error_alert" style="display: none;"></div>
        <p class="d-flex">

            <button class="btn btn-primary" id="login_btn" type="submit">登入</button>
            <span class="select-none">&nbsp;</span>
            <button class="btn btn-secondary toggle-btn">註冊</button>
            <span class="select-none">&nbsp;</span>
            <button class="btn btn-light skip_login_btn">訪客登入</button>

        </p>
    </div>

    <div id="sign-up-dialog" class="login-dialog" style="display: none;">
        <h1>註冊</h1>
        <p>註冊新帳號<br>
            如果已經有帳號，請登入</p>
        <p>

        <div class="form-check mb-3">
            <label for="signup_user_nickname">你的暱稱:</label><input type="text    " class="form-control" placeholder="暱稱"
                id="signup_user_nickname">
            <div class="invalid-feedback" id="signup_user_nickname_alert" style="display: none;"></div>

        </div>
        <div class="form-check mb-3">
            <label for="sign_up_user_account">你的使用者帳號:</label>

            <div class="input-group mb-3">
                <span class="input-group-text">@</span><input type="text" class="form-control" placeholder="使用者帳號"
                    id="sign_up_user_account">
            </div>

            <div class="invalid-feedback" id="signup_user_account_alert" style="display: none;"></div>
        </div>
        <div class="form-check mb-3">
            <label for="sign_up_user_password">密碼:</label><input type="password" class="form-control"
                placeholder="使用者密碼" id="sign_up_user_password">
            <div class="invalid-feedback" id="signup_user_password_alert" style="display: none;"></div>

        </div>
        <div class="form-check mb-3">
            <label for="sign_up_user_password_2">確認密碼:</label><input type="password" class="form-control"
                placeholder="確認密碼" id="sign_up_user_password_2">
            <div class="invalid-feedback" id="signup_user_password_2_alert" style="display: none;"></div>

        </div>
        <div class="alert alert-danger" id="signup_error_alert" style="display: none;"></div>
        <p class="d-flex">

            <button class="btn btn-primary" id="signup_btn">註冊</button>
            <span class="select-none">&nbsp;</span>
            <button class="btn btn-secondary toggle-btn">登入</button>
            <span class="select-none">&nbsp;</span>
            <button class="btn btn-light skip_login_btn">訪客登入</button>
        </p>

    </div>
    <div onclick="imginfo()" style="
    box-shadow: 0px 0px 20px 5px rgba(255, 255, 255, 0.21);
    backdrop-filter: blur(10px);border-radius: 5px;
    background: rgba(216, 216, 216, 0.15);position: fixed; bottom:0;width: fit-content;padding: 5px; cursor: pointer;">
        <span class="text-light text-opacity-50">
            <i class="bi bi-info-circle"></i>
        </span>
    </div>


    <div class="modal fade " id="Modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable ">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        id="modal-close-btn"></button>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-esc-button">
                        取消
                    </button>
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal" id="modal-enter-button">
                        確定
                    </button>

                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="position-fixed bottom-0 end-0 p-3 toast-container"></div>

    <!--<script src="/socket.io/socket.io.js"></script>
    -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.js'
        integrity='sha512-CX7sDOp7UTAq+i1FYIlf9Uo27x4os+kGeoT7rgwvY+4dmjqV0IuE/Bl5hVsjnQPQiTOhAX1O2r2j5bjsFBvv/A=='
        crossorigin='anonymous'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.1/js/bootstrap.js'
        integrity='sha512-sVtqu//5Nt9ezFxWXCLcYjITUpvE2uin3m6zeClCHkHfWOshi732EGhrim4qL7kawS5ipwU/rmQo7ZirKzDvfQ=='
        crossorigin='anonymous'></script>

    <script>
        var status = "login";


        //{title,body,escCallBack,enterCallBack}
        function PopupAlert(par) {
            console.log(par)
            let _Modal = new bootstrap.Modal(document.getElementById('Modal'));
            $('.modal-title').html('');
            $('.modal-body').html('');
            $('#modal-esc-btn').removeAttr('onclick');
            $('#modal-enter-btn').removeAttr('onclick');
            $('#modal-esc-btn').removeAttr('disabled');
            $('#modal-enter-btn').removeAttr('disabled');
            $('#modal-enter-btn').show();
            $('#modal-esc-btn').show();
            $(".modal-backdrop").remove();
            $("#modal-close-btn").show();

            //------------------------------------------------//

            $('.modal-title').html(par.title);
            $('.modal-body').html(par.body);

            if (par.escCallBack == 'dismiss') { $('#modal-esc-btn').show(); }
            else if (par.escCallBack == 'x') { $('#modal-esc-button').hide(); }
            else { $('#modal-esc-button').attr('onclick', par.escCallBack); }

            if (par.enterCallBack == 'dismiss') { $('#modal-enter-btn').show(); }
            else if (par.enterCallBack == 'x') { $('#modal-enter-button').hide(); }
            else { $('#modal-enter-button').attr('onclick', par.enterCallBack); }



            if (par.closeButtonStatue == undefined || par.closeButtonStatue == true) {
                $("#modal-close-btn").show()

            } else {

                $("#modal-close-btn").hide()
            }


            _Modal.toggle();


        }
        window.mobileAndTabletCheck = function () {
            let check = false;
            (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);
            return check;
        };

        window.setup = function () {
            choose_img()

            if (window.mobileAndTabletCheck()) {
                resize_tab()
            }
            if ($.UrlParam("signuped") == "true") {
                BS_Toast.show({
                    icon: 'bi-person-fill',
                    iconClass: '',
                    title: '註冊成功',
                    body: `請使用你的帳號登入`,
                    toastClass: "text-bg-success"
                })
            }
        }


        $("#user_account").on("blur", function (e) {
            if ($("#user_account").val() == "") {
                $("#login_user_account_alert").html("*請填寫此欄位*").show();
                $("#user_account").addClass("is-invalid")
            }
        })

        window.onkeydown = function (e) {
            if (e.keyCode == 13 & status == "login") {
                if ($("#user_account").val() == "") {
                    $("#login_user_account_alert").html("*請填寫此欄位*").show();
                    $("#user_account").addClass("is-invalid")
                } else {

                    $("#login_btn").attr("disabled", true).html("正在登入 " + `<div class="spinner-border  spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>`)

                    $(".skip_login_btn").attr("disabled", true)
                    $("#user_account").attr("disabled", true)
                    $("#user_password").attr("disabled", true);
                    $(".toggle-btn").attr("disabled", true)

                    status = "logining"
                    $("#login_error_alert").text("").hide()

                    fetch('/account/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user: {
                                account: $("#user_account").val(),
                                pass: $("#user_password").val()
                            }
                        })
                    })
                        .then(res => res.json())

                        .then((json) => {
                            if (json.code === "failed") {
                                $("#login_error_alert").text(json.par.text).show();


                                $("#user_account").removeAttr("disabled")
                                $("#user_password").removeAttr("disabled")
                                $(".toggle-btn").removeAttr("disabled")
                                $(".skip_login_btn").removeAttr("disabled")
                                $("#login_btn").removeAttr("disabled").html("登入")
                                status = "login"

                            } else {
                                if (!$.UrlParam("next")) {
                                    location.href = "/"
                                } else {
                                    location.href = "/file" + $.UrlParam("next")
                                }
                            }
                        })

                        .catch(error => {
                            console.log(error)
                            $("#login_error_alert").text("發生錯誤，暫時無法將你登入").show();
                            $("#user_account").removeAttr("disabled")
                            $("#user_password").removeAttr("disabled")
                            $(".skip_login_btn").removeAttr("disabled")
                            $(".toggle-btn").removeAttr("disabled")
                            $("#login_btn").removeAttr("disabled").html("登入")
                            status = "login"
                        })
                }
            }
        }

        $("#login_btn").on("click", function (e) {
            if ($("#user_account").val() == "") {
                $("#login_user_account_alert").html("*請填寫此欄位*").show();
                $("#user_account").addClass("is-invalid")
            } else {

                $("#login_btn").attr("disabled", true).html("正在登入 " + `<div class="spinner-border  spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>`)

                $(".skip_login_btn").attr("disabled", true)
                $("#user_account").attr("disabled", true)
                $("#user_password").attr("disabled", true);
                $(".toggle-btn").attr("disabled", true)

                status = "logining"
                $("#login_error_alert").text("").hide()

                fetch('/account/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: {
                            account: $("#user_account").val(),
                            pass: $("#user_password").val()
                        }
                    })
                })
                    .then(res => res.json())

                    .then((json) => {
                        if (json.code === "failed") {
                            $("#login_error_alert").text(json.par.text).show();


                            $("#user_account").removeAttr("disabled")
                            $("#user_password").removeAttr("disabled")
                            $(".toggle-btn").removeAttr("disabled")
                            $(".skip_login_btn").removeAttr("disabled")
                            $("#login_btn").removeAttr("disabled").html("登入")
                            status = "login"

                        } else {
                            if (!$.UrlParam("next")) {
                                location.href = "/"
                            } else {
                                location.href = "/file" + $.UrlParam("next")
                            }

                        }
                    })

                    .catch(error => {
                        console.log(error)
                        $("#login_error_alert").text("發生錯誤，暫時無法將你登入").show();
                        $("#user_account").removeAttr("disabled")
                        $("#user_password").removeAttr("disabled")
                        $(".skip_login_btn").removeAttr("disabled")
                        $(".toggle-btn").removeAttr("disabled")
                        $("#login_btn").removeAttr("disabled").html("登入")
                        status = "login"
                    })
            }
        })
        $("#user_account").on("focus", function (e) {
            $("#login_user_account_alert").hide()
            $("#user_account").removeClass("is-invalid")
            $("#login_error_alert").text("").hide()
        })
        $("body").on("keydown", function (event) {
            if (event.which == 13 && status == "login") {
                if ($("#user_account").val() == "") {
                    $("#login_user_account_alert").html("*請填寫此欄位*").show();
                    $("#user_account").addClass("is-invalid")
                } else if (event.which == 13 && status == "signup") {
                    if ($("#sign_up_user_password").val() !== $("#sign_up_user_password_2").val()) {
                        $("#signup_error_alert").text("兩次輸入的密碼不同，請重新輸入").show()
                    }
                    else if (IfStrIsBlank($("#sign_up_user_password").val()) || $("#sign_up_user_password").val().split("").length > 30 || $("#sign_up_user_password").val().split("").length < 6) {
                        $("#signup_error_alert").text("密碼需在6到30字之間，建議包含特殊符號以提升安全性").show()
                    }
                    else {
                        $("#sign_up_user_account").attr("disabled", true)
                        $("#sign_up_user_password").attr("disabled", true)
                        $("#sign_up_user_password_2").attr("disabled", true)
                        $("#signup_user_nickname").attr("disabled", true)
                        $(".skip_login_btn").attr("disabled", true)
                        $("#signup_btn").attr("disabled", true).html("正在註冊 " + `<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>`)

                        fetch("/account/signup", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                action: "signup",
                                uid: $("#sign_up_user_account").val(),
                                pass: $("#sign_up_user_password").val(),
                                nickname: $("#signup_user_nickname").val()
                            })
                        })
                            .then(res => res.json())
                            .then(data => {
                                console.log(data)
                                if (data.code === "failed") {
                                    $("#signup_error_alert").text(data.par.text).show();
                                    $("#sign_up_user_account").removeAttr("disabled")
                                    $("#sign_up_user_password").removeAttr("disabled")
                                    $("#sign_up_user_password_2").removeAttr("disabled")
                                    $("#signup_user_nickname").removeAttr("disabled")
                                    $(".skip_login_btn").removeAttr("disabled")
                                    $("#signup_btn").removeAttr("disabled").html("註冊")

                                } else {
                                    $("#signup_error_alert").removeClass("alert-danger").addClass("alert-success").text(data.par.text).show()
                                    $(".skip_login_btn").removeAttr("disabled")
                                    $("#signup_btn").html("註冊")
                                    $("#sign_up_user_account").val("")
                                    $("#sign_up_user_password").val("")
                                    $("#sign_up_user_password_2").val("")
                                    $("#signup_user_nickname").val("")


                                }
                            })
                            .catch(error => {
                                console.log(error)
                                $("#signup_error_alert").text("發生錯誤，暫時無法註冊你的帳號").show()
                                $("#sign_up_user_account").removeAttr("disabled")
                                $("#sign_up_user_password").removeAttr("disabled")
                                $("#sign_up_user_password_2").removeAttr("disabled")
                                $("#signup_user_nickname").removeAttr("disabled")
                                $(".skip_login_btn").removeAttr("disabled")
                                $("#signup_btn").removeAttr("disabled").html("註冊")

                            })
                    }
                }
            }

        });


        $(".skip_login_btn").on("click", function (e) {
            PopupAlert({
                title: "確定繼續?",
                body: "你將使用訪客身分登入，部分功能將受到限制",
                escCallBack: "dismiss",
                enterCallBack: "guestlogin()"
            })
        })

        function guestlogin(e) {
            $("#login_btn").attr("disabled", true).html("正在登入 " + `<div class="spinner-border  spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>`)

            $(".skip_login_btn").attr("disabled", true)
            $("#user_account").attr("disabled", true)
            $("#user_password").attr("disabled", true);
            $(".toggle-btn").attr("disabled", true)
            fetch('/account/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user: {
                        account: "guest",
                        pass: "password"
                    }
                })
            })
                .then(res => res.json())

                .then((json) => {
                    if (json.code === "failed") {
                        $("#login_error_alert").text(json.par.text).show();


                        $("#user_account").removeAttr("disabled")
                        $("#user_password").removeAttr("disabled");
                        $("#login_btn").removeAttr("disabled").html("登入")

                    } else {
                        if (!$.UrlParam("next")) {
                            location.href = "/"
                        } else {
                            location.href = "/file" + $.UrlParam("next")
                        }
                    }
                });
        }
        $("#signup_btn").on("click", function (e) {
            if ($("#sign_up_user_password").val() !== $("#sign_up_user_password_2").val()) {
                $("#signup_error_alert").text("兩次輸入的密碼不同，請重新輸入").show()
            }
            else if (IfStrIsBlank($("#sign_up_user_password").val()) || $("#sign_up_user_password").val().split("").length > 30 || $("#sign_up_user_password").val().split("").length < 6) {
                $("#signup_error_alert").text("密碼需在6到30字之間，建議包含特殊符號以提升安全性").show()
            }
            else {
                $("#sign_up_user_account").attr("disabled", true)
                $("#sign_up_user_password").attr("disabled", true)
                $("#sign_up_user_password_2").attr("disabled", true)
                $("#signup_user_nickname").attr("disabled", true)
                $(".skip_login_btn").attr("disabled", true)
                $("#signup_btn").attr("disabled", true).html("正在註冊 " + `<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>`)

                fetch("/account/signup", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: "signup",
                        uid: $("#sign_up_user_account").val(),
                        pass: $("#sign_up_user_password").val(),
                        nickname: $("#signup_user_nickname").val()
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        console.log(data)
                        if (data.code === "failed") {
                            $("#signup_error_alert").text(data.par.text).show();
                            $("#sign_up_user_account").removeAttr("disabled")
                            $("#sign_up_user_password").removeAttr("disabled")
                            $("#sign_up_user_password_2").removeAttr("disabled")
                            $("#signup_user_nickname").removeAttr("disabled")
                            $(".skip_login_btn").removeAttr("disabled")
                            $("#signup_btn").removeAttr("disabled").html("註冊")

                        } else {
                            $("#signup_error_alert").removeClass("alert-danger").addClass("alert-success").text(data.par.text).show()
                            $(".skip_login_btn").removeAttr("disabled")
                            $("#signup_btn").html("註冊")
                            $("#sign_up_user_account").val("")
                            $("#sign_up_user_password").val("")
                            $("#sign_up_user_password_2").val("")
                            $("#signup_user_nickname").val("")


                        }
                    })
                    .catch(error => {
                        console.log(error)
                        $("#signup_error_alert").text("發生錯誤，暫時無法註冊你的帳號").show()
                        $("#sign_up_user_account").removeAttr("disabled")
                        $("#sign_up_user_password").removeAttr("disabled")
                        $("#sign_up_user_password_2").removeAttr("disabled")
                        $("#signup_user_nickname").removeAttr("disabled")
                        $(".skip_login_btn").removeAttr("disabled")
                        $("#signup_btn").removeAttr("disabled").html("註冊")

                    })
            }
        })
        $("#signup_user_nickname").on("input", function (e) {
            $("#signup_error_alert").hide()
        })
        $("#sign_up_user_account").on("input", function (e) {
            $("#signup_error_alert").hide()
        })
        $("#sign_up_user_password").on("input", function (e) {
            $("#signup_error_alert").hide()
        })
        $("#sign_up_user_password_2").on("input", function (e) {
            $("#signup_error_alert").hide()
        })
        $(".toggle-btn").on("click", function (e) {
            if (status == "login") {
                status = "signup"
                $("#login-dialog").hide()
                $("#sign-up-dialog").show()
                fetch("/account/signup/getid", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => res.json())
                    .then(data => $("#sign_up_user_account").val(data.par.uid))
            } else if (status == "signup") {
                status = "login"
                $("#sign-up-dialog").hide()
                $("#login-dialog").show()
            }
            console.log(status)
        })



        function IfStrIsBlank(str) {
            let _arr = str.split(" "),
                _s;
            for (i = 0; i < _arr.length; i++) {

                if (_arr[i] !== " " && _arr[i] !== "") {


                    return false
                }
            }

            return true
        }
        (function ($) {
            $.UrlParam = function (name) {
                //宣告正規表達式
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                /*
                 * window.location.search 獲取URL ?之後的參數(包含問號)
                 * substr(1) 獲取第一個字以後的字串(就是去除掉?號)
                 * match(reg) 用正規表達式檢查是否符合要查詢的參數
                */
                var r = window.location.search.substr(1).match(reg);
                //如果取出的參數存在則取出參數的值否則回穿null
                if (r != null) return (r[2]); return null;
            }
        })(jQuery);

        //date -> formated str (y/m/d)
        //time -> formated str (h:m:s)
        //pack -> {year,month,date,day,hour,minute,second}
        function getTime(type) {
            var DATE = new Date(),
                year = DATE.getFullYear(),
                mont = DATE.getMonth() + 1,
                date = DATE.getDate(),
                day = DATE.getDay(),
                //--------------------//
                hour = DATE.getHours(),
                mins = DATE.getMinutes(),
                secs = DATE.getSeconds();

            if (type == "date") {
                return `${year} / ${mont} / ${date}`
            } else
                if (type == "time") {
                    return `${hour} : ${mins} : ${secs}`
                } else
                    if (type == "pack") {
                        let par = {
                            "year": year,
                            "month": mont,
                            "date": date,
                            "day": day,
                            "hour": hour > 10 ? hour : '0' + hour,
                            "minute": mins > 10 ? mins : '0' + mins,
                            "second": secs > 10 ? secs : '0' + secs
                        }

                        return par
                    }
        }
        //{ icon,         iconClass,     title,  body  toastClass}
        //  ^ex:bi-text  ^ex:text-success              ^ex:text-bg-primary
        var BS_Toast = {
            toast_id: 0,

            show: function (data) {
                let hour = getTime("pack").hour,
                    mins = getTime("pack").minute;
                $("#toast").append(` 
            <div id='BS-Toast-${BS_Toast.toast_id}' class="toast ${data.toastClass}" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-header" >
                <i class='bi ${data.icon} ${data.iconClass}'></i>&nbsp;
                <strong class="me-auto">${data.title}</strong>
                <small>${hour}:${mins}</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
             </div>
            <div class="toast-body">${data.body}</div>
            </div>`)

                var toastElList = document.querySelectorAll('.toast')
                var toastList = [...toastElList].map(toastEl => new bootstrap.Toast(toastEl))
                let Thistoast = new bootstrap.Toast(document.getElementById(`BS-Toast-${BS_Toast.toast_id}`))

                Thistoast.show()

                BS_Toast.toast_id++
            }
        }




        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        var describe = ["日出", "湖泊", "星空", "星空", "山峰", "森林", "星系", "極光","湖泊","瀑布"] 
        var whiteText = [false, true, true, true, false, false, true, false,false,false]
        var currentImg;
        function choose_img(params) {

           
            if (!$.UrlParam("image")) {
                var index = getRandomInt(1, 10)
                $("#background").html(`<img src="/lib/background/background-${index}.png" id="bg-img" draggable="false" class="select-none" alt="無法顯示背景圖片" onload="resize_tab();$('#loading-layer').remove()" onerror=" $('#loading-status').attr('class', 'text-danger').text('發生暫時性的錯誤，請刷新頁面')">`)
                if (whiteText[index - 1] === true) {
                    $(".login-dialog").css("color", "var(--bs-light)").addClass("text-opacity-75")
                }
                $("#bg-text").text(describe[index - 1])
                resize_tab()
                resize_tab()
                currentImg = index
            } else {

                if (0 < Number($.UrlParam("image")) && Number($.UrlParam("image")) < 11) {

                    var index = Number($.UrlParam("image"))
                    $("#background").html(`<img src="/lib/background/background-${index}.png" id="bg-img" draggable="false" class="select-none" alt="無法顯示背景圖片" onload="resize_tab();$('#loading-layer').remove()" onerror=" $('#loading-status').attr('class', 'text-danger').text('發生暫時性的錯誤，請刷新頁面')">`)
                    if (whiteText[index - 1] === true) {
                        $(".login-dialog").css("color", "var(--bs-light)").addClass("text-opacity-75")
                    }
                    $("#bg-text").text(describe[index - 1])
                    resize_tab()
                    resize_tab()
                    currentImg = index
                } else {
                    var index = getRandomInt(1, 10)
                    $("#background").html(`<img src="/lib/background/background-${index}.png" id="bg-img" draggable="false" class="select-none" alt="無法顯示背景圖片" onload="resize_tab();$('#loading-layer').remove()" onerror=" $('#loading-status').attr('class', 'text-danger').text('發生暫時性的錯誤，請刷新頁面')">`)
                    if (whiteText[index - 1] === true) {
                        $(".login-dialog").css("color", "var(--bs-light)").addClass("text-opacity-75")
                    }
                    $("#bg-text").text(describe[index - 1])
                    resize_tab()
                    resize_tab()
                    currentImg = index
                }
            }


        }

        function changeImg(params) {

     
            var index = currentImg++
            if(currentImg+1>11){
                var index = getRandomInt(1, 10)
            }else{
                var index = currentImg++
            }
            $("#background").html(`<img src="/lib/background/background-${index}.png" id="bg-img" style="display:none" draggable="false" class="select-none" alt="無法顯示背景圖片" onload="resize_tab();$(this).show()" onerror=" $('#loading-status').attr('class', 'text-danger').text('發生暫時性的錯誤，請刷新頁面')">`)
            if (whiteText[index - 1] === true) {
                $(".login-dialog").css("color", "var(--bs-light)").addClass("text-opacity-75")
            }else{
                $(".login-dialog").css("color", "#000").removeClass("text-opacity-75")
            }
            $("#bg-text").text(describe[index - 1])
            resize_tab()
            resize_tab()
            currentImg = index
            imginfo()
        }

        /*$(window).resize(function () {
            resize_tab();
        }).resize();*/
        window.onresize = function (e) {
            resize_tab();
            resize_tab()

        }
        function resize_tab() {

            var viewportWidth = $(window).innerWidth();
            var viewportHeight = $(window).innerHeight();

            var width = $('#bg-img').width();
            var height = $('#bg-img').height();


            if ((viewportWidth / viewportHeight) > (width / height)) {

                $('#bg-img').css({
                    'width': '100%',
                    'height': 'auto',
                    'margin-left': 0 - width / 2,
                    'margin-top': 0 - height / 2
                });


            } else {
                $('#bg-img').css({
                    'width': 'auto',
                    'height': '100%',
                    'margin-left': 0 - width / 2,
                    'margin-top': 0 - height / 2
                });
            }
        }
        function imginfo(params) {
            PopupAlert({
                title: "關於背景圖片",
                body: `<h3>${describe[currentImg - 1]}</h3>
                由<a href="https://openai.com/dall-e-2/" target="_blank">DALL·E 2</a>生成</span><br>
                完整圖片<a href="https://whiteboard.up.railway.app/lib/background/background-${currentImg}.png" target="_blank">請點我</a><br>
                <button class="btn btn-sm btn-primary" data-bs-dismiss="modal" onclick="changeImg()">換一張背景圖片</button>`,
                escCallBack: "x",
                enterCallBack: "dismiss"
            })
        }


        window.onerror = function () {
            $("#loading-status").attr("class", "text-danger").text("發生錯誤，請刷新頁面")
        }
    </script>

</body>

</html>