<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>畫板 - 即時線上協作</title>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.2/css/bootstrap.css'
        integrity='sha512-+QrNe4Kul4TNKwDK+EJM71C9z5I9I/iYLEIJPYTfmXouMSU8tkayWYnOsAKjDAaOOH21+MS747IPTYcD+2euuQ=='
        crossorigin='anonymous' />
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.2/font/bootstrap-icons.css'
        integrity='sha512-c0+vSv9tnGS4fzwTIBFPcdCZ0QwP+aTePvZeAJkYpbj67KvQ5+VrJjDh3lil48LILJxhICQf66dQ8t/BJyOo/g=='
        crossorigin='anonymous' />

    <style>
        .alert-hidden {
            display: none;
        }

        .edit-color-container {
            border: 1px solid var(--bs-gray-300);
            height: 73px;
            border-radius: 5px;
            width: 70px;
            text-align: center;


        }

        .tab-pane {

            padding: 12px;
        }

        .dropdown-item {
            user-select: none;
            cursor: pointer;
        }

        #styleSpan-1,
        #styleSpan-2 {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin: 5px auto;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        /*
        body>div:last-child {
            margin: 50px 0 0 20px;
        }*/


        .select-none {
            user-select: none !important;
        }

        .center {
            text-align: center !important;
        }

        .size-1em {
            font-size: 1em !important;
            font-weight: normal !important;

        }

        .buttom {
            position: fixed;
            bottom: 0;
        }

        .chat-msg-others {

            margin-top: 2px;
            min-width: 2em;
            background: var(--bs-info);
            color: var(--bs-light);
            border-radius: 1em;
            padding-top: 5px;
            padding-bottom: 5px;
            padding-left: 10px;
            padding-right: 10px;
            text-align: center;
            width: fit-content;
            float: left;
            clear: both;
            border-top-left-radius: 0;
        }

        .chat-msg-myself {
            margin-top: 2px;
            min-width: 2em;
            background: var(--bs-link-color);
            color: var(--bs-light);
            border-radius: 1em;
            padding-top: 5px;
            padding-bottom: 5px;
            padding-left: 10px;
            padding-right: 10px;
            text-align: center;
            width: fit-content;
            float: right;
            clear: both;
            border-top-right-radius: 0;
        }

        #app {
            margin: 8px
        }
    </style>
</head>

<body onload="window.setup()">
    <div id="app">
        <noscript>
            <div class="alert alert-danger" role="alert">
                本程式需要JavaScript才能正確執行，請先開啟JavaScript!
            </div>
            <style>
                nav,
                button,
                input,
                canvas,
                span,
                #ui-bottom,
                .tab-content {
                    display: none;
                }
            </style>
        </noscript>
        <div id="header" style="    
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    justify-content: space-between;
    margin-bottom: 10px;">
            <div id="top-left-tool-bar">
                <div class="btn-group" role="group">
                    <button class="btn btn-secondary btn-sm " type="button" data-bs-toggle="tooltip" data-bs-title="儲存">
                        <i class="bi bi-file-earmark-post"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm " type="button" data-bs-toggle="tooltip"
                        data-bs-title="上一步">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm " type="button" data-bs-toggle="tooltip"
                        data-bs-title="下一步">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-secondary btn-sm " type="button" data-bs-toggle="tooltip" data-bs-title="共用"
                        onclick="_data('share')">
                        <i class="bi bi-share"></i>
                    </button>
                </div>
            </div>
            <div style="text-align: center;"><span class="text-danger file-unsaved-mark"></span><span
                    class="file-name">未命名專案</span> - 白板</div>
            <div id="top-right-tool-bar">

                <button disabled class="btn btn-secondary btn-sm" id="person-option-button" type="button"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="person-icon"><i class="bi bi-person-fill-x select-none"></i></span>&nbsp;&nbsp;<span
                        class="user-nickname">正在確認使用者...</span>
                </button>
                <ul class="dropdown-menu">
                    <div class="px-3 pt-1 pb-1 text-muted" style="max-width: 200px;"><span
                            class="user-nickname">使用者暱稱</span></div>
                    <li onclick="$('#v-pills-3-tab').click();$('#nav-0-tab').click()"
                        class="dropdown-item bi bi-person-circle"> 帳號</li>
                    <li onclick="$('#v-pills-2-tab').click();$('#nav-0-tab').click()" class="dropdown-item bi bi-gear">
                        設定</li>
                    <li onclick=" window.logout()" class="dropdown-item bi bi-box-arrow-right"> 登出</li>
                </ul>
            </div>
        </div>
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">

                <button class="nav-link " id="nav-0-tab" type="button" role="button" aria-selected="false"
                    style="background-color: #0099ff; color:#fff;" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvas" aria-controls="offcanvas">

                    檔案
                </button>



                <button class="nav-link active" id="nav-1-tab" data-bs-toggle="tab" data-bs-target="#nav-1"
                    type="button" role="tab" aria-controls="nav-1" aria-selected="true"
                    onclick="canvas.isDrawingMode = true;$('#color-pickers-container').appendTo($('#color-pickers-container-1'))">
                    畫筆

                </button>


                <button class="nav-link" id="nav-2-tab" data-bs-toggle="tab" data-bs-target="#nav-2" type="button"
                    role="tab" aria-controls="nav-2" aria-selected="false"
                    onclick="canvas.isDrawingMode = false;$('#color-pickers-container').appendTo($('#color-pickers-container-2'))">
                    圖形
                </button>

                <button class="nav-link" id="nav-3-tab" data-bs-toggle="tab" data-bs-target="#nav-3" type="button"
                    role="tab" aria-controls="nav-3" aria-selected="false"
                    onclick="canvas.isDrawingMode = false;$('#color-pickers-container').appendTo($('#color-pickers-container-3'))">
                    文字
                </button>

                <button class="nav-link" id="nav-4-tab" data-bs-toggle="tab" data-bs-target="#nav-4" type="button"
                    role="tab" aria-controls="nav-4" aria-selected="false" onclick="canvas.isDrawingMode = false">
                    物件
                </button>

                <button class="nav-link" id="nav-5-tab" data-bs-toggle="tab" data-bs-target="#nav-5" type="button"
                    role="tab" aria-controls="nav-5" aria-selected="false" onclick="canvas.isDrawingMode = false">
                    共用
                </button>

            </div>
        </nav>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="nav-1" role="tabpanel" aria-labelledby="nav-1-tab" tabindex="0">
                <div class="d-flex">
                    <div id="color-pickers-container-1">
                        <div class="d-flex" style="width: fit-content;" id="color-pickers-container">
                            <div class="edit-color-container">
                                <div id="styleSpan-1"
                                    style="background-image: none; background-color: rgb(186, 243, 255); color: rgb(0, 0, 0);"
                                    onclick="document.getElementById('color-picker-1').jscolor.show()"></div>
                                <div style="cursor: pointer;"
                                    onclick="document.getElementById('color-picker-1').jscolor.show()">主色
                                </div>
                                <input id="color-picker-1" class="color-picker"
                                    data-jscolor="{previewElement:'#styleSpan-1',value:'DF068CFF',closeButton:true,closeText:'關閉'}"
                                    type="hidden">
                            </div>
                            <span class="select-none">&nbsp;</span>
                            <div class="edit-color-container">
                                <div id="styleSpan-2"
                                    style="background-image: none; background-color: rgb(186, 243, 255); color: rgb(0, 0, 0);"
                                    onclick="document.getElementById('color-picker-2').jscolor.show()"></div>
                                <div style="cursor: pointer;"
                                    onclick="document.getElementById('color-picker-2').jscolor.show()">輔色
                                </div>
                                <input id="color-picker-2" class="color-picker"
                                    data-jscolor="{previewElement:'#styleSpan-2',value:'FFFFFFFF',closeButton:true,closeText:'關閉'}"
                                    type="hidden">
                            </div>
                        </div>
                    </div>
                    <span class="select-none">&nbsp;</span>
                    <div class="vr"></div>
                    <span class="select-none">&nbsp;</span>
                    <div class="center">
                        <span style="font-size:1.25em;">筆刷</span>
                        <div class="d-flex">
                            <select id="" class="form-select" style="width: fit-content !important;">
                                <option value="pencil">鉛筆</option>
                                <option value="">圓點</option>
                                <option value="">直條紋</option>
                                <option value="">橫條紋</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-2" role="tabpanel" aria-labelledby="nav-2-tab" tabindex="0">
                <div class="d-flex">
                    <div id="color-pickers-container-2"></div>
                    <span class="select-none">&nbsp;</span>
                    <div class="vr"></div>
                    <span class="select-none">&nbsp;</span>
                    <div class="d-flex">

                        <div class="center">
                            <span style="font-size:1.25em;">形狀</span>
                            <div class="d-flex">
                                <button class="btn btn-primary draw-tool" data-bs-toggle="tooltip" data-bs-title="三角形"
                                    onclick="_fabric('triangle')"><i class="bi bi-triangle"></i></button>
                                <span class="select-none">&thinsp;</span>

                                <button class="btn btn-primary draw-tool" data-bs-toggle="tooltip" data-bs-title="圓形"
                                    onclick="_fabric('circle')"><i class="bi bi-circle"></i></button>
                                <span class="select-none">&thinsp;</span>

                                <button class="btn btn-primary draw-tool" data-bs-toggle="tooltip" data-bs-title="方形"
                                    onclick="_fabric('square')"><i class="bi bi-square"></i></button>
                                <span class="select-none">&thinsp;</span>
                            </div>
                        </div>
                    </div>
                    <span class="select-none">&nbsp;</span>
                    <div class="vr"></div>
                    <span class="select-none">&nbsp;</span>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-3" role="tabpanel" aria-labelledby="nav-3-tab" tabindex="0">
                <div class="d-flex">
                    <div id="color-pickers-container-3"></div>
                    <span class="select-none">&nbsp;</span>
                    <div class="vr"></div>
                    <span class="select-none">&nbsp;</span>
                    <div style="width: fit-content; height: fit-content;">
                        <div class="d-flex">
                            <input type="text" class="form-control draw-tool" id="itext-input" placeholder="輸入文字..."
                                style="width: fit-content !important;">
                            <span class="select-none">&nbsp;</span>
                            <button class="btn btn-primary draw-tool"
                                onclick="_fabric('itext',$('#itext-input').val())"><i
                                    class="bi bi-check-circle"></i></button>
                        </div>

                        <div class="d-flex mt-1">
                            <div class="btn-group" role="group">

                                <input type="checkbox" id="canvas-text-bold" class="draw-tool btn-check">
                                <label class="btn btn-outline-primary btn-sm" for="canvas-text-bold"><i
                                        class="bi bi-type-bold"></i></label>

                                <input type="checkbox" id="canvas-text-italic" class="draw-tool btn-check">
                                <label class="btn btn-outline-primary btn-sm" for="canvas-text-italic"><i
                                        class="bi bi-type-italic"></i></label>

                                <input type="checkbox" id="canvas-text-strikethrough" class="draw-tool btn-check">
                                <label class="btn btn-outline-primary btn-sm" for="canvas-text-strikethrough"><i
                                        class="bi bi-type-strikethrough"></i></label>

                                <input type="checkbox" id="canvas-text-underline" class="draw-tool btn-check">
                                <label class="btn btn-outline-primary btn-sm" for="canvas-text-underline"><i
                                        class="bi bi-type-underline"></i></label>

                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="tab-pane fade" id="nav-4" role="tabpanel" aria-labelledby="nav-4-tab" tabindex="0">

                <div class="d-flex">
                    <div class="d-flex p-1">
                        <div class="center">
                            <span style="font-size:1.25em;">群組</span>
                            <div class="d-flex">
                                <button class="btn btn-primary" data-bs-placement="bottom" data-bs-toggle="tooltip"
                                    data-bs-title="組成群組" onclick="canvas.getActiveObject().toGroup()">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                                <span class="select-none">&thinsp;</span>
                                <button class="btn btn-primary" data-bs-placement="bottom" data-bs-toggle="tooltip"
                                    data-bs-title="解散群組" onclick="canvas.getActiveObject().toActiveSelection();">
                                    <i class="bi bi-dash-circle"></i>
                                </button>
                            </div>
                        </div>
                        <span class="select-none">&nbsp;</span>
                        <div class="vr"></div>
                        <span class="select-none">&nbsp;</span>
                        <div class="center">
                            <span style="font-size:1.25em;">剪貼</span>
                            <div class="d-flex">
                                <button class="btn btn-primary draw-tool" onclick="_fabric('copy')"
                                    data-bs-placement="bottom" data-bs-toggle="tooltip" data-bs-title="複製"><svg
                                        height="16" viewBox="0 0 48 48" width="16" xmlns="http://www.w3.org/2000/svg">
                                        <path fill="white"
                                            d="M32 2h-24c-2.21 0-4 1.79-4 4v28h4v-28h24v-4zm6 8h-22c-2.21 0-4 1.79-4 4v28c0 2.21 1.79 4 4 4h22c2.21 0 4-1.79 4-4v-28c0-2.21-1.79-4-4-4zm0 32h-22v-28h22v28z" />
                                    </svg></button>
                                <span class="select-none">&thinsp;</span>
                                <button class="btn btn-primary draw-tool" onclick="_fabric('paste')"
                                    data-bs-placement="bottom" data-bs-toggle="tooltip" data-bs-title="貼上"><i
                                        class="bi bi-clipboard"></i></button>
                            </div>
                        </div>
                        <span class="select-none">&nbsp;</span>
                        <div class="vr"></div>
                        <span class="select-none">&nbsp;</span>
                        <div class="center">
                            <span style="font-size:1.25em;">刪除</span>
                            <div class="d-flex">
                                <button class="btn btn-danger" data-bs-placement="bottom" data-bs-toggle="tooltip"
                                    data-bs-title="刪除" onclick="_fabric('delete')"><i class="bi bi-trash"></i></button>

                            </div>
                        </div>



                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-5" role="tabpanel" aria-labelledby="nav-5-tab" tabindex="0">

                <div class="d-flex">
                    <div class="d-flex">
                        <div class="center">
                            <span style="font-size:1.25em;">共用文件</span>
                            <div class="d-flex">
                                <button class="btn btn-primary" onclick="_data('share')"><i class="bi bi-lock"></i>
                                    未共用</button>
                            </div>
                        </div>
                        <span class="select-none">&nbsp;</span>
                        <div class="vr"></div>
                        <span class="select-none">&nbsp;</span>
                        <div class="center">
                            <span style="font-size:1.25em;">即時討論</span>
                            <div class="d-flex center">
                                <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas"
                                    data-bs-target="#offcanvasRight" aria-controls="offcanvasRight"
                                    onclick="$('#chat-text-input').focus()">開啟</button>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <center>
            <canvas id="canvas" style="border: 1px solid #000 ;"></canvas>
        </center>
    </div>
    <span class="select-none">&nbsp;&nbsp;<p>&nbsp;&nbsp;</p></span>
    <div
        style="position: fixed;bottom:0;background-color:rgb(223, 223, 223);width: 100%;padding: 2px;padding-left: 5px;">
        <span id="sys-icon">
            <div class="spinner-border spinner-border-sm text-primary" role="status"><span
                    class="visually-hidden">Loading...</span></div>
        </span>
        <span id="sys-status">資料讀取中</span>&nbsp;&nbsp;

    </div>



    <div class="modal fade " id="Modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable ">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        id="modal-close-btn"></button>
                </div>
                <div class="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-esc-button">
                        取消
                    </button>
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal" id="modal-enter-button">
                        確定
                    </button>

                </div>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" style="width: 100%;"
        tabindex="-1" id="offcanvas" aria-labelledby="offcanvasLabel">
        <div class="offcanvas-header">
            <h1 class="offcanvas-title" id="offcanvasLabel">
                <button class="btn btn-light btn-lg" data-bs-dismiss="offcanvas">
                    <h1 class="m-0"><i class="w-75 h-75 bi bi-arrow-left-circle "></i></h1>
                </button>
            </h1>

        </div>
        <div class="offcanvas-body d-flex">
            <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="nav-link active" id="v-pills-1-tab" data-bs-toggle="pill" data-bs-target="#v-pills-1"
                    type="button" role="tab" aria-controls="v-pills-1" aria-selected="true">
                    <h4 class="m-0">
                        <i class="bi bi-file-earmark"></i>
                        常用
                    </h4>
                </button>
                <button class="nav-link" id="v-pills-3-tab" data-bs-toggle="pill" data-bs-target="#v-pills-3"
                    type="button" role="tab" aria-controls="v-pills-3" aria-selected="false">
                    <h4 class="m-0">
                        <i class="bi bi-person-circle"></i>
                        帳號
                    </h4>
                </button>
                <button class="nav-link" id="v-pills-2-tab" data-bs-toggle="pill" data-bs-target="#v-pills-2"
                    type="button" role="tab" aria-controls="v-pills-2" aria-selected="false">
                    <h4 class="m-0">
                        <i class="bi bi-gear"></i>
                        設定
                    </h4>
                </button>

            </div>
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="v-pills-1" role="tabpanel"
                    aria-labelledby="v-pills-home-tab">
                    <h3>檔案</h3>
                    <div id="file-list">

                        <div onclick="
                           _data('new')" data-bs-dismiss="offcanvas" style="
            display: inline-block; text-align: center; border-radius: 5px; 
            border: 1px solid rgb(59, 59, 59); padding:  15px; user-select: none;
            margin: 2px; cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                                class="bi bi-plus-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path
                                    d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                            </svg>
                            <p></p>
                            <h5>新增</h5>
                            <small>(沒有快速鍵)</small>

                        </div>

                        <div onclick="_data('upload')" data-bs-dismiss="offcanvas" style=" display: inline-block; text-align: center; 
                            border-radius: 5px; border: 1px solid rgb(59, 59, 59); padding:  15px; user-select: none;
                            margin: 2px; cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                                class="bi bi-folder2-open" viewBox="0 0 16 16">
                                <path
                                    d="M1 3.5A1.5 1.5 0 0 1 2.5 2h2.764c.958 0 1.76.56 2.311 1.184C7.985 3.648 8.48 4 9 4h4.5A1.5 1.5 0 0 1 15 5.5v.64c.57.265.94.876.856 1.546l-.64 5.124A2.5 2.5 0 0 1 12.733 15H3.266a2.5 2.5 0 0 1-2.481-2.19l-.64-5.124A1.5 1.5 0 0 1 1 6.14V3.5zM2 6h12v-.5a.5.5 0 0 0-.5-.5H9c-.964 0-1.71-.629-2.174-1.154C6.374 3.334 5.82 3 5.264 3H2.5a.5.5 0 0 0-.5.5V6zm-.367 1a.5.5 0 0 0-.496.562l.64 5.124A1.5 1.5 0 0 0 3.266 14h9.468a1.5 1.5 0 0 0 1.489-1.314l.64-5.124A.5.5 0 0 0 14.367 7H1.633z" />
                            </svg>
                            <p></p>
                            <h5>開啟</h5>
                            <small>(Ctrl + O)</small>

                        </div>

                        <div onclick="_data('save')" data-bs-dismiss="offcanvas" style="
            display: inline-block; text-align: center; border-radius: 5px; 
            border: 1px solid rgb(59, 59, 59); padding:  15px; user-select: none;
            margin: 2px; cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor"
                                class="bi bi-file-earmark-post" viewBox="0 0 16 16">
                                <path
                                    d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z" />
                                <path
                                    d="M4 6.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-7zm0-3a.5.5 0 0 1 .5-.5H7a.5.5 0 0 1 0 1H4.5a.5.5 0 0 1-.5-.5z" />
                            </svg>
                            <p></p>
                            <h5>儲存</h5>
                            <small>(Ctrl + S)</small>


                        </div>
                        <br>
                    </div>

                </div>
                <div class="tab-pane fade" id="v-pills-2" role="tabpanel">

                    <h3>設定</h3>
                </div>

                <div class="tab-pane fade" id="v-pills-3" role="tabpanel">

                    <h3>帳號</h3>

                    <div class="d-flex">
                        <div>
                            <h1 class="person-icon"><i class="bi bi-person-fill-x text-danger"></i></h1>
                        </div>
                        <div id="person-data">
                            <h5 class="user-nickname"><span class="text-danger">正在確認使用者...</span></h5>
                            <i class="user-id">@使用者ID</i>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="logout-btn">登出</button>

                    <div id="user-alert" class="alert alert-danger alert-hidden"></div>
                    <div id="user-logout-alert" class="alert alert-danger alert-hidden"></div>
                </div>

            </div>
        </div>
    </div>


    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasRightLabel">討論區</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body" id="chat-body" style="padding-top: 0;">
            <div id="chat-msgBox" style="position: sticky;top:0;background:var(--bs-light);"></div>
            <div id="chat-msgs" class="mb-5" style="overflow: auto;">

            </div>

        </div>
        <div id="chat-tool" class="buttom p-2 d-flex bg-light" style="width:inherit">

            <input type="text" style="border-radius: 5em; flex-grow: 1;" class="form-control" id="chat-text-input"
                placeholder="輸入新訊息...">
            <span class="select-none">&thinsp;</span>
            <button class="btn btn-primary" id="chat-msg-send-btn" data-bs-toggle="tooltip" data-bs-title="送出訊息"><i
                    class="bi bi-send"></i></button>
        </div>
    </div>

    <div id="toast" class="position-fixed bottom-0 end-0 p-3 toast-container"></div>
    <script src="/socket.io/socket.io.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.js"
        integrity="sha512-q7T9VUu0gBgAGV3YkcvI0wjeBJONO5Cg/+688NkDC6qupjUvEG9ZmNK4GjZWvWuuT1VIjS0abwE1IKXVew8Ohw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.js'
        integrity='sha512-CX7sDOp7UTAq+i1FYIlf9Uo27x4os+kGeoT7rgwvY+4dmjqV0IuE/Bl5hVsjnQPQiTOhAX1O2r2j5bjsFBvv/A=='
        crossorigin='anonymous'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.js'
        integrity='sha512-gMrnU9iM+azBQtrSC8kTJy6+g+hjaIHnElQmb41QeHNTGYjbbtm0BptpIMgXYpS6iyWq9bPkxrcqgK8aqRsjAg=='
        crossorigin='anonymous'></script>
    <script>
        var _User


        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
        var popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]')
        var popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl))

        var toastElList = document.querySelectorAll('.toast')
        var toastList = [...toastElList].map(toastEl => new bootstrap.Toast(toastEl, option))


        $("#canvas").attr('width', window.innerWidth - 60)
        $("#canvas").attr('height', Math.abs(window.innerHeight - 290))
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jscolor/2.5.1/jscolor.js'
        integrity='sha512-UP6tOIJfUgQv7uNUL4IXb8HDO1PlEUVSOuPGUcX11obi7Eh24geCoL2X+8JxB4tA9BfdppntOzqrmVQUblSYYQ=='
        crossorigin='anonymous'></script>



    <script>
        const socket = io();

        const canvas = new fabric.Canvas('canvas', {
            isDrawingMode: true
        });

        var ActiveTab = 'nav-1-tab'

        //date -> formated str (y/m/d)
        //time -> formated str (h:m:s)
        //pack -> {year,month,date,day,hour,minute,second}
        function getTime(type) {
            var DATE = new Date(),
                year = DATE.getFullYear(),
                mont = DATE.getMonth() + 1,
                date = DATE.getDate(),
                day = DATE.getDay(),
                //--------------------//
                hour = DATE.getHours(),
                mins = DATE.getMinutes(),
                secs = DATE.getSeconds();

            if (type == "date") {
                return `${year} / ${mont} / ${date}`
            } else
                if (type == "time") {
                    return `${hour} : ${mins} : ${secs}`
                } else
                    if (type == "pack") {
                        let par = {
                            "year": year,
                            "month": mont,
                            "date": date,
                            "day": day,
                            "hour": hour > 10 ? hour : '0' + hour,
                            "minute": mins > 10 ? mins : '0' + mins,
                            "second": secs > 10 ? secs : '0' + secs
                        }

                        return par
                    }
        }



        //{text,icon}
        function SetStatus(params) {
            var sys_icon = {
                success: `<i class="bi bi-check-circle-fill text-success"></i>`,
                info: `<i class="bi bi-info-circle-fill text-primary"></i>`,
                error: `<i class="bi bi-x-circle-fill text-danger"></i>`,
                warn: `<i class="bi bi-exclamation-triangle-fill" style="color:#f4871e"></i>`,
                loading: `<i class="bi bi-arrow-repeat text-primary " id="loading-spin"></i>`
            }
            $("#sys-icon").html(eval("sys_icon." + params.icon));

            $("#sys-status").text(params.text)




        }

        window.logout = function (e) {
            BS_Toast.show({
                icon: 'bi-box-arrow-right',
                iconClass: '',
                title: '登出',
                body: `正在準備登出...<br>`
            })
            fetch("/account/logout", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
                .then(res => res.json())
                .then(r => {
                    if (r.code === "success") {

                        location.reload()
                    } else {
                        $("#user-logout-alert").text("發生錯誤，暫時無法將你登出").show()
                        BS_Toast.show({
                            icon: 'bi-box-arrow-right',
                            iconClass: '',
                            title: '登出',
                            body: `正在準備登出...<br>`,
                            toastClass: "bg-danger"
                        })
                    }
                })
                .catch(error => {
                    $("#user-logout-alert").text("發生錯誤，暫時無法將你登出").show();
                    BS_Toast.show({
                        icon: 'bi-box-arrow-right',
                        iconClass: '',
                        title: '發生錯誤',
                        body: `無法登出<br>`,
                        toastClass: "bg-danger"
                    })
                })
        }


        //{ icon,         iconClass,     title,  body  toastClass}
        //  ^ex:bi-text  ^ex:text-success              ^ex:text-bg-primary
        var BS_Toast = {
            toast_id: 0,

            show: function (data) {
                let hour = getTime("pack").hour,
                    mins = getTime("pack").minute;
                $("#toast").append(` 
            <div id='BS-Toast-${BS_Toast.toast_id}' class="toast ${data.toastClass}" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-header" >
                <i class='bi ${data.icon} ${data.iconClass}'></i>&nbsp;
                <strong class="me-auto">${data.title}</strong>
                <small>${hour}:${mins}</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
             </div>
            <div class="toast-body">${data.body}</div>
            </div>`)

                var toastElList = document.querySelectorAll('.toast')
                var toastList = [...toastElList].map(toastEl => new bootstrap.Toast(toastEl))
                let Thistoast = new bootstrap.Toast(document.getElementById(`BS-Toast-${BS_Toast.toast_id}`))

                Thistoast.show()

                BS_Toast.toast_id++
            }
        }

        //{title,body,escCallBack,enterCallBack}
        function PopupAlert(par) {
            console.log(par)
            let _Modal = new bootstrap.Modal(document.getElementById('Modal'));
            $('.modal-title').html('');
            $('.modal-body').html('');
            $('#modal-esc-btn').removeAttr('onclick');
            $('#modal-enter-btn').removeAttr('onclick');
            $('#modal-esc-btn').removeAttr('disabled');
            $('#modal-enter-btn').removeAttr('disabled');
            $('#modal-enter-btn').show();
            $('#modal-esc-btn').show();
            $(".modal-backdrop").remove();
            $("#modal-close-btn").show();

            //------------------------------------------------//

            $('.modal-title').html(par.title);
            $('.modal-body').html(par.body);

            if (par.escCallBack == 'dismiss') { $('#modal-esc-btn').show(); }
            else if (par.escCallBack == 'x') { $('#modal-esc-button').hide(); }
            else { $('#modal-esc-button').attr('onclick', par.escCallBack); }

            if (par.enterCallBack == 'dismiss') { $('#modal-enter-btn').show(); }
            else if (par.enterCallBack == 'x') { $('#modal-enter-button').hide(); }
            else { $('#modal-enter-button').attr('onclick', par.enterCallBack); }



            if (par.closeButtonStatue == undefined || par.closeButtonStatue == true) {
                $("#modal-close-btn").show()

            } else {

                $("#modal-close-btn").hide()
            }


            _Modal.toggle();
        }





        window.setup = function (par) {
            console.log("白板 %cBETA", "background:#0d6efd;border-radius:5px;padding-left:5px;padding-right:5px;color:#fff")
            BS_Toast.show({
                icon: 'bi-person-fill',
                iconClass: '',
                title: '身分驗證中...',
                body: `正在確認身分資料，請稍候片刻...`
            })

            fetch('/account/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({

                })
            })
                .then(res => res.json())
                .then(data => {
                    console.log(data)
                    if (data.login) {
                        BS_Toast.show({
                            icon: 'bi-person-fill-check',
                            iconClass: 'text-success',
                            title: '歡迎使用',
                            body: `${data.nickname} , 歡迎使用白板<br>`
                        })
                        $(".user-nickname").text(data.nickname)
                        $(".user-id").text(data.account)
                        $("#person-option-button").removeAttr("disabled")
                        if (data.account === "@admin") {
                            $(".person-icon").html(`<i class="bi bi-person-fill-gear"></i>`)
                        } else if (data.account === "@guest") {
                            $(".person-icon").html(`<i class="bi bi-person-fill-lock"></i>`)
                        } else {
                            $(".person-icon").html(`<i class="bi bi-person-fill"></i>`)
                        }
                        _User = data;
                    } else {
                        BS_Toast.show({
                            icon: 'bi-person-fill-x',
                            iconClass: 'text-danger',
                            title: '身分驗證錯誤',
                            body: `請重新登入，以繼續使用白板`
                        })
                    }
                })

        }




        function _fabric(obj, par) {

            if (obj == "copy") {
                // clone what are you copying since you
                // may want copy and paste on different moment.
                // and you do not want the changes happened
                // later to reflect on the copy.
                canvas.getActiveObject().clone(function (cloned) {
                    _clipboard = cloned;
                });
            } else if (obj == "paste") {
                _clipboard.clone(function (clonedObj) {
                    canvas.discardActiveObject();
                    clonedObj.set({
                        left: clonedObj.left + 10,
                        top: clonedObj.top + 10,
                        evented: true,
                    });
                    if (clonedObj.type === 'activeSelection') {
                        // active selection needs a reference to the canvas.
                        clonedObj.canvas = canvas;
                        clonedObj.forEachObject(function (obj) {
                            canvas.add(obj);
                        });
                        // this should solve the unselectability
                        clonedObj.setCoords();
                    } else {
                        canvas.add(clonedObj);
                    }
                    _clipboard.top += 10;
                    _clipboard.left += 10;
                    canvas.setActiveObject(clonedObj);
                    canvas.requestRenderAll();
                })
            } else if (obj == "circle") {

                var shape = new fabric.Ellipse({


                    rx: 50, ry: 50,
                    width: 100,
                    height: 100,
                    fill: $("#color-picker-1").attr("data-current-color")
                })
                canvas.add(shape)
            } else if (obj == "square") {

                var shape = new fabric.Rect({


                    width: 100,
                    height: 100,
                    fill: $("#color-picker-1").attr("data-current-color")
                })
                canvas.add(shape)
            }
            else if (obj == "triangle") {
                var shape = new fabric.Triangle({

                    width: 100,
                    height: 100,
                    fill: $("#color-picker-1").attr("data-current-color")
                })

                canvas.add(shape)
            }
            else if (obj == "itext") {
                if (par == "") {
                    var shape = new fabric.IText("按兩下以編輯文字", {
                        left: 0,
                        top: 0,
                        fill: $("#color-picker-1").attr("data-current-color"),
                        fontWeight: document.getElementById("canvas-text-bold").checked ? "bold" : "normal",
                        underline: document.getElementById("canvas-text-underline").checked ? true : false,
                        linethrough: document.getElementById("canvas-text-strikethrough").checked ? true : false,
                        fontStyle: document.getElementById("canvas-text-italic").checked ? 'italic' : 'normal',
                    })
                } else {
                    var shape = new fabric.IText(par, {
                        left: 0,
                        top: 0,
                        fill: $("#color-picker-1").attr("data-current-color"),
                        fontWeight: document.getElementById("canvas-text-bold").checked ? "bold" : "normal",
                        underline: document.getElementById("canvas-text-underline").checked ? true : false,
                        linethrough: document.getElementById("canvas-text-strikethrough").checked ? true : false,
                        fontStyle: document.getElementById("canvas-text-italic").checked ? 'italic' : 'normal',
                    })
                }


                canvas.add(shape)
            }
            else if (obj == "delete") {
                var selected = canvas.getActiveObjects(),
                    selGroup = new fabric.ActiveSelection(selected, {
                        canvas: canvas
                    });
                if (selGroup) {
                    if (confirm('刪除所選取的物件?')) {
                        selGroup.forEachObject(function (obj) {
                            canvas.remove(obj);
                        });

                    }
                } else {
                    alert("請先選擇物件")
                }
                canvas.renderAll()
            }

            //   socket.emit("CanvasUpdate", JSON.stringify(canvas))
            canvas.renderAll()
        }

        /*window.onkeydown = function (e) {
            if (e.keyCode == 46) {
 
                var selected = canvas.getActiveObjects(),
                    selGroup = new fabric.ActiveSelection(selected, {
                        canvas: canvas
                    });
                if (selGroup) {
                    if (confirm('Deleted selected image(s)?')) {
                        selGroup.forEachObject(function (obj) {
                            canvas.remove(obj);
 
                        });
 
                       // socket.emit("CanvasUpdate", JSON.stringify(canvas))
                        /*PopupAlert({
                            title:"刪除選取項目",
                            body:`選取的項目會從畫布上移除，但仍會保留在資料區中`,
                            enterCallBack:`
                            var selected = _Canvas.getActiveObjects(),
                            selGroup = new fabric.ActiveSelection(selected, {
                                canvas: _Canvas
                            });
                            selGroup.forEachObject(function (obj) {
                                _Canvas.remove(obj);
                            });
                            `,
                            escCallBack:"dismiss"
                        })*/
        /*      }
          }
      } else {
 
      }
      // Use discardActiveObject to remove the selection border
      canvas.discardActiveObject().renderAll();
  }*/
        var msgid = 0
        window.onkeydown = function (e) {
            if (e.keyCode == 13 && (document.activeElement == document.getElementById("chat-text-input")) && (!IfStrIsBlank($('#chat-text-input').val()))) {
                msgid++
                $("#chat-msgs").append(`
            <div id=chat-msgId-${msgid}></div>
            `)
                $(`#chat-msgId-${msgid}`).text($('#chat-text-input').val()).attr("class", "chat-msg-myself")
                socket.emit('ChatMsg', $('#chat-text-input').val())
                $('#chat-text-input').val("")
                $("#chat-body").scrollTop($("#chat-msgs").height());
            }
        }

        $("#chat-msg-send-btn").on("click", function (e) {
            if (!IfStrIsBlank($('#chat-text-input').val())) {
                msgid++
                $("#chat-msgs").append(`
            <div id=chat-msgId-${msgid}></div>
            `)
                $(`#chat-msgId-${msgid}`).text($('#chat-text-input').val()).attr("class", "chat-msg-myself")
                socket.emit('ChatMsg', $('#chat-text-input').val())
                $('#chat-text-input').val("")

                $("#chat-body").scrollTop($("#chat-msgs").height());
            }
        })

        document.getElementById("offcanvasRight").addEventListener("shown.bs.offcanvas", e => {
            $('#chat-text-input').focus()
        })


        socket.on("connect", () => {
            console.log(socket.id);
            SetStatus({ text: "連線成功", icon: "success" })
            $("#chat-msgBox").html("")
        });

        socket.on("CanvasUpdate", (e) => {

            canvas.loadFromJSON(e)
            canvas.renderAll()
        });

        socket.on("ChatMsg", (e) => {
            msgid++
            $("#chat-msgs").append(`
            <div id=chat-msgId-${msgid}></div>
            `)
            $(`#chat-msgId-${msgid}`).text(e).attr("class", "chat-msg-others")
            $("#chat-body").scrollTop($("#chat-msgs").height());

        })
        socket.on("data_update", (e) => {

            msgid = e.chat_id
        })
        socket.on("disconnect", () => {
            console.log(socket.id);
            SetStatus({ text: "連線失敗", icon: "error" })
            $("#chat-msgBox").html(`
            <div class="alert alert-danger">
            無法連線到討論區
            </div>
            `)
            PopupAlert({

                title: "連線到伺服器時發生錯誤",
                body: `<h1 class="text-primary">: (</h1><span class="text-secondary">目前無法連接至伺服器<br>無法同步資料</span><p></p><div class="accordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"  aria-expanded="false">可能原因</button></h2><div id="collapseOne" class="accordion-collapse collapse " data-bs-parent="#accordionExample"><div class="accordion-body"><ol><li>沒有網路連線或連線品質不佳</li><li>伺服器發生故障</li></ol></div></div></div></div>`,
                escCallBack: "x",
                enterCallBack: "dismiss"
            })

        });

        /*
                canvas.on('object:modified', e => {
                    socket.emit("CanvasUpdate", JSON.stringify(canvas))
                })
        
                canvas.on('before:transform', e => {
                    socket.emit("CanvasUpdate", JSON.stringify(canvas))
                })
                canvas.on('path:created', e => {
                    socket.emit("CanvasUpdate", JSON.stringify(canvas))
                })
        
                canvas.on('selection:created', e => {
        
                });
        */
        canvas.on('selection:cleared', e => {

        });

        $("#logout-btn").on("click", function (e) {
            window.logout()
        })

        function _data(type, par, data) {
            if (type == "save") {

            }
            else if (type == "upload") {
                if (par !== "callback") {
                    PopupAlert({
                        title: "上傳專案",
                        body: `<div class="alert alert-warning">注意:若未儲存目前專案，變更將會<span class="text-danger">遺失</span></div>上傳檔案<br><input type="file" id="upload-file-input" style="display:none"><label for="upload-file-input" class="btn btn-primary">選擇檔案</label>`,
                        escCallBack: "dismiss",
                        enterCallBack: `_data('upload','callback')`
                    })
                } else {

                }
            }
            else if (type == "new") {
                if (par !== "callback") {
                    if (_User.account !== "@guest") {
                        PopupAlert({

                            title: "新建專案",
                            body: `<div class="alert alert-warning">注意:若未儲存目前專案，變更將會<span class="text-danger">遺失</span></div>輸入檔案名稱:<br><input type="text" class="form-control" placeholder="檔案名稱" id="create-file-name-input"><br> <div class="accordion" id="create-accordion"><div class="accordion-item"><h2 class="accordion-header" id="headingOne"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#create-collapse" aria-expanded="true" aria-controls="create-collapse">進階選項</button></h2><div id="create-collapse" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#create-accordion"><div class="accordion-body">選擇檔案存儲位置:<br><div class="form-check form-check-inline"><input class="form-check-input" checked type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"><label class="form-check-label" for="inlineRadio1">本機</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2"><label class="form-check-label" for="inlineRadio2">雲端</label></div></div></div></div></div><script>if (_User.account == "@guest") {$("#inlineRadio2").attr("disabled")}<\/script>`,
                            escCallBack: "dismiss",
                            enterCallBack: `_data('new','callback',$('#create-file-name-input').val())`
                        })
                    } else {
                        PopupAlert({

                            title: "新建專案",
                            body: `<div class="alert alert-warning">注意:若未儲存目前專案，變更將會<span class="text-danger">遺失</span></div>輸入檔案名稱:<br><input type="text" class="form-control" placeholder="檔案名稱" id="create-file-name-input"><br> <div class="accordion" id="create-accordion"><div class="accordion-item"><h2 class="accordion-header" id="headingOne"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#create-collapse" aria-expanded="true" aria-controls="create-collapse">進階選項</button></h2><div id="create-collapse" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#create-accordion"><div class="accordion-body">選擇檔案存儲位置:<br><div class="form-check form-check-inline"><input class="form-check-input" checked type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"><label class="form-check-label" for="inlineRadio1">本機</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" disabled><label class="form-check-label" for="inlineRadio2">雲端</label></div></div></div></div></div>`,
                            escCallBack: "dismiss",
                            enterCallBack: `_data('new','callback',$('#create-file-name-input').val())`
                        })
                    }



                } else {
                    //do with file name
                    console.log(data)
                    if (data.includes("/") || data.includes(":") || data.includes("*") || data.includes("?") || data.includes('"') || data.includes("<") || data.includes(">") || data.includes("|")) {
                        if (_User.account !== "@guest") {
                            PopupAlert({
                                title: "新建專案",
                                body: `<div class="alert alert-danger">檔案名稱 ${data} 無效，請重新輸入</div>重新輸入檔案名稱:<br><input type="text" class="form-control" placeholder="檔案名稱" id="create-file-name-input" value="${data}"><br> <div class="accordion" id="create-accordion"><div class="accordion-item"><h2 class="accordion-header" id="headingOne"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#create-collapse" aria-expanded="true" aria-controls="create-collapse">進階選項</button></h2><div id="create-collapse" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#create-accordion"><div class="accordion-body">選擇檔案存儲位置:<br><div class="form-check form-check-inline"><input class="form-check-input" checked type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"><label class="form-check-label" for="inlineRadio1">本機</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2"><label class="form-check-label" for="inlineRadio2">雲端</label></div></div></div></div></div><script>if (_User.account == "@guest") {$("#inlineRadio2").attr("disabled")}<\/script>`,
                                escCallBack: "dismiss",
                                enterCallBack: `_data('new','callback',$('#create-file-name-input').val())`
                            })
                        } else {
                            PopupAlert({
                                title: "新建專案",
                                body: `<div class="alert alert-danger">檔案名稱 ${data} 無效，請重新輸入</div>重新輸入檔案名稱:<br><input type="text" class="form-control" placeholder="檔案名稱" id="create-file-name-input"  value="${data}"><br> <div class="accordion" id="create-accordion"><div class="accordion-item"><h2 class="accordion-header" id="headingOne"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#create-collapse" aria-expanded="true" aria-controls="create-collapse">進階選項</button></h2><div id="create-collapse" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#create-accordion"><div class="accordion-body">選擇檔案存儲位置:<br><div class="form-check form-check-inline"><input class="form-check-input" checked type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"><label class="form-check-label" for="inlineRadio1">本機</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2" disabled><label class="form-check-label" for="inlineRadio2">雲端</label></div></div></div></div></div>`,
                                escCallBack: "dismiss",
                                enterCallBack: `_data('new','callback',$('#create-file-name-input').val())`
                            })
                        }
                    } else {
                        $(".file-name").text(data)
                    }
                }
            }
            else if (type == "share") {

                if (par == undefined) {
                    PopupAlert({
                        title: "共用",
                        body: `
                        <div class="d-flex">
                            <div class="input-group" style="width:fit-content !important;flex-grow:1;">
                                <span class="input-group-text">@</span>
                                <input class="form-control" placeholder="使用者ID..." id="share-uid-input" oninput='$("#share-invalid-feedback").hide();$("#share-uid-input").removeClass("is-invalid")'>
                            </div>
                            
                            <span class="select-none">&nbsp;</span>
                            <select class="form-select" style="width:fit-content !important;" id="share-type-select">
                                <option value="editor">編輯者</option>
                                <option value="viewer">檢視者</option>
                                <option value="disable">禁止存取</option>
                            </select>
                            <span class="select-none">&nbsp;</span>
                            <button class="btn btn-primary" onclick="_data('share','check')">新增</button>


                        </div>
                        <div class="invalid-feedback" id="share-invalid-feedback"></div>
                        <hr>
                        <h6>管理存取權</h6>
                        <span>點選下方項目，即可在上方更改權限</span>
                        <div style="overflow-y:scroll;max-height:150px" id="share-info">
                            

                            <div class="alert alert-primary" data-user-id="@all_know_link_user" data-share="viewer" onclick="_data('share','update')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16"><path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/><path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/></svg>
                                <span class="select-none">&nbsp;</span><span class="select-none">&nbsp;</span>所有知道連結的使用者&nbsp;&nbsp;[檢視者]
                            </div>
                             
                            <div class="alert alert-primary" data-user-id="@all_logined_user" data-share="viewer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg> 
                                <span class="select-none">&nbsp;</span><span class="select-none">&nbsp;</span>所有已經登入的使用者&nbsp;&nbsp;[檢視者]
                            </div>
                        </div>`,
                        escCallBack: "dismiss",
                        enterCallBack: "_data('share','submit')"
                    })
                } else

                    if (par == "check") {

                        if (IfStrIsBlank($("#share-uid-input").val())) {

                            $("#share-invalid-feedback").text("請檢查輸入內容").show();
                            $("#share-uid-input").addClass("is-invalid")

                        } else {

                            $("#share-invalid-feedback").hide()
                            if ($("#share-type-select").val() == "editor") {
                                $("#share-info").append(`
                        
                        <div class="alert alert-success" >
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg> 
                                <span class="select-none">&nbsp;</span><span class="select-none">&nbsp;</span>@${$("#share-uid-input").val()}&nbsp;&nbsp;[編輯者]
                        </div>
                        `)
                            } else if ($("#share-type-select").val() == "viewer") {
                                $("#share-info").append(`
                        
                        <div class="alert alert-primary" >
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg> 
                                <span class="select-none">&nbsp;</span><span class="select-none">&nbsp;</span>@${$("#share-uid-input").val()}&nbsp;&nbsp;[檢視者]
                        </div>
                        `)
                            } else {
                                $("#share-info").append(`
                        
                        <div class="alert alert-danger" >
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg> 
                                <span class="select-none">&nbsp;</span><span class="select-none">&nbsp;</span>@${$("#share-uid-input").val()}&nbsp;&nbsp;[禁止存取]
                        </div>
                        `)
                            }
                        }
                    }
                    else if (par == "update") {


                    }
                    else if (par == "submit") {


                    }

            }
        }


        function IfStrIsBlank(str) {
            let _arr = str.split(" "),
                _s;
            for (i = 0; i < _arr.length; i++) {

                if (_arr[i] !== " " && _arr[i] !== "") {


                    return false
                }
            }

            return true
        }


        window.onerror = function () {
            BS_Toast.show({
                icon: 'bi-x-circle-fill',
                iconClass: 'text-danger',
                title: '發生錯誤',
                body: `: ( <br>程式發生錯誤`,
                toastClass: "text-bg-danger"
            })
        }
    </script>
</body>

</html>